<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール設定 - コンプラナビ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <header class="header">
        <div class="container header-inner">
            <a href="index.html" class="logo">コンプラナビ</a>
            <nav class="nav">
                <ul>
                    <li><a href="dashboard.html">ダッシュボード</a></li>
                    <li><a href="profile.html">プロフィール</a></li>
                    <li><a href="subscription.html">サブスクリプション</a></li>
                    <li><a href="#" id="logout-btn" style="color: var(--primary-color);">ログアウト</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main style="padding: 60px 0;">
        <div class="container" style="max-width: 600px;">
            <h1 style="margin-bottom: 40px; color: #0a192f;">プロフィール設定</h1>

            <div class="glass-card">
                <form id="profile-form">
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a192f;">会社種別</label>
                        <select id="company-type"
                            style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 1rem;"
                            required>
                            <option value="">選択してください</option>
                            <option value="株式会社">株式会社</option>
                            <option value="合同会社">合同会社</option>
                            <option value="合名会社">合名会社</option>
                            <option value="合資会社">合資会社</option>
                            <option value="個人事業主">個人事業主</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a192f;">業種</label>
                        <select id="industry"
                            style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 1rem;"
                            required>
                            <option value="">選択してください</option>
                            <option value="製造業">製造業</option>
                            <option value="建設業">建設業</option>
                            <option value="卸売業">卸売業</option>
                            <option value="小売業">小売業</option>
                            <option value="飲食業">飲食業</option>
                            <option value="サービス業">サービス業</option>
                            <option value="IT・情報通信業">IT・情報通信業</option>
                            <option value="医療・福祉">医療・福祉</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 600; color: #0a192f;">従業員数</label>
                        <select id="employee-count"
                            style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 1rem;"
                            required>
                            <option value="">選択してください</option>
                            <option value="1-5人">1-5人</option>
                            <option value="6-20人">6-20人</option>
                            <option value="21-50人">21-50人</option>
                            <option value="51-100人">51-100人</option>
                            <option value="101人以上">101人以上</option>
                        </select>
                    </div>

                    <button type="submit" class="btn primary-btn" style="width: 100%;">保存</button>
                </form>

                <div id="success-message"
                    style="display: none; margin-top: 20px; padding: 15px; background: #d1fae5; color: #065f46; border-radius: 6px; text-align: center;">
                    プロフィールを保存しました
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 SPACE GLEAM. All Rights Reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { auth, db, onAuthStateChanged } from './js/firebase-config.js';
        import { doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        let currentUser = null;

        // 認証チェック
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = user;

            // 既存データ読み込み
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('company-type').value = userData.company_type || '';
                document.getElementById('industry').value = userData.industry || '';
                document.getElementById('employee-count').value = userData.employee_count || '';
            }
        });

        // フォーム送信
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const companyType = document.getElementById('company-type').value;
            const industry = document.getElementById('industry').value;
            const employeeCount = document.getElementById('employee-count').value;

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userRef);

                const data = {
                    company_type: companyType,
                    industry: industry,
                    employee_count: employeeCount,
                    updated_at: new Date()
                };

                if (userDoc.exists()) {
                    await updateDoc(userRef, data);
                } else {
                    await setDoc(userRef, {
                        ...data,
                        uid: currentUser.uid,
                        email: currentUser.email,
                        subscription_status: 'trial',
                        trial_end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                        created_at: new Date()
                    });
                }

                // 成功メッセージ表示
                const successMsg = document.getElementById('success-message');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving profile:', error);
                alert('保存に失敗しました。もう一度お試しください。');
            }
        });

        // ログアウト
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = 'index.html';
        });
    </script>
</body>

</html>